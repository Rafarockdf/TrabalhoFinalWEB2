<!DOCTYPE html>
<html lang="pt-BR" data-theme="modern">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Alimentação</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"
        integrity="sha512-NmLkDIU1C/C88wi324HBc+S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="../css/alimentacao.css">

</head>
<style>
    .container-registro-alimentos {
        display: flex;
        width: 100%;
        border-radius: 1rem;
        overflow-y:auto;
        box-shadow: 0 2px 5px var(--clr-card-shadow);
        background-color: var(--clr-card);
    }

    .box-alimentos-busca {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .box-alimentos-selecionados {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        border-left: 1px solid var(--clr-card-border); /* Barra de separação */
    }

    #form-buscar-alimento {
        display: flex;
        gap: 10px;
        width: 80%;
        margin-bottom: 20px;
    }

    #alimento {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid var(--clr-card-border);
        border-radius: 0.5rem;
        background-color: var(--clr-background);
        color: var(--clr-font);
        outline: none;
    }

    #form-buscar-alimento button {
        padding: 10px 15px;
        border: none;
        border-radius: 0.5rem;
        background-color: var(--clr-button);
        color: var(--clr-button-text);
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #form-buscar-alimento button:hover {
        background-color: #28a745;
    }

    #lista-alimentos {
        list-style: none;
        padding: 0;
        margin-top: 10px;
        width: 80%;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--clr-card-border);
        border-radius: 0.5rem;
        background-color: var(--clr-background);
    }

    #lista-alimentos li {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #lista-alimentos li:last-child {
        border-bottom: none;
    }

    #lista-alimentos li:hover {
        background-color: #f9f9f9;
    }

    .icone-selecionar {
        color: var(--clr-highlight);
        margin-left: 10px;
        cursor: pointer;
    }

    #tabela-refeicao {
        width: 80%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    #tabela-refeicao th,
    #tabela-refeicao td {
        border: 1px solid var(--clr-card-border);
        padding: 8px;
        text-align: left;
    }

    #tabela-refeicao th {
        background-color: #f2f2f2;
        color: var(--clr-font);
    }

    #tabela-refeicao tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    #btn-registrar-refeicao {
        padding: 10px 20px;
        border: none;
        border-radius: 0.5rem;
        background-color: var(--clr-highlight);
        color: var(--clr-button-text);
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s ease;
    }

    #btn-registrar-refeicao:hover {
        background-color: #0077a3;
    }

    h3 {
        color: var(--clr-font);
        margin-bottom: 10px;
    }

    .quantidade-input {
        width: 80px;
        padding: 5px;
        border: 1px solid var(--clr-card-border);
        border-radius: 0.3rem;
        text-align: center;
        background-color: var(--clr-background);
        color: var(--clr-font);
        outline: none;
    }

    .remover-item {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        margin-left: 10px;
        font-size: 1em;
    }
    .select-refeicao{
        padding: 1px;
        margin-top: 2rem;
        font-size: 1.4rem;
        text-align: center;
        border: 1px solid var(--clr-card-border);
        border-radius: 0.3rem;
        background-color: var(--clr-background);
        color: var(--clr-font);
        transition: var(--transition);
        width: 81%;
        max-height: 3rem;


    }
    .select-refeicao:focus{
        border-color: var(--clr-highlight);
        background-color: var(--clr-card-hover);
    }
</style>

<body>
    <div class="menu-toggle">
        <i class="fas fa-bars"></i>
    </div>
    <div class="sidebar">
        <div class="logo">
            <div class="cross"></div>
        </div>
        <div class="menu">
            <ul>
                <li><i class="fas fa-home"></i> <span class="menu-text">Página Inicial</span></li>
                <li><a href="../../Login/html/login.html" style="text-decoration: none; color:inherit"><i class="fas fa-chart-line"></i> <span class="menu-text">Dashboard</span></a></li>
                <li><a href="../../Dasboard/html/dashboard.html" style="text-decoration: none; color:inherit"><i class="fas fa-clipboard"></i> <span class="menu-text">Registros Atividades</span></a></li>
                <li><a href="telaRegistros.html" style="text-decoration: none; color:inherit"><i class="fas fa-apple-alt"></i> <span class="menu-text">Regitros Alimentação</span></a></li>
            </ul>
        </div>
        <div class="switch">
            <i class="fas fa-sun"></i>
            <span class="switch__track"></span>
            <i class="fas fa-moon"></i>
        </div>
    </div>

    <div class="container">
        <div class="box">
            <h2 class="title">Registro de Alimentação</h2>
            <form id="form-buscar-alimento" class="form">
                <label for="alimento" style="display: none;">Digite o nome de um alimento:</label>
                <input type="text" name="alimento" id="alimento" placeholder="Digite o nome de um alimento" required>
                <button type="submit">Buscar</button>
            </form>
            <div class="container-registro-alimentos">
                <div class="box-alimentos-busca">
                    <h3>Buscar Alimentos</h3>
                    <ul id="lista-alimentos">
                        </ul>
                </div>
                <div class="box-alimentos-selecionados">
                    <h3>Alimentos Selecionados</h3>
                    <table id="tabela-refeicao">
                        <thead>
                            <tr>
                                <th>Nome do Alimento</th>
                                <th>Quantidade (g)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    <select id="refeicao" class="select-refeicao">
                        <option value="nao_selecionado">--</option>
                        <option value="cafe-manha">Café da manhã</option>
                        <option value="lanche-manha">Lanche da manhã</option>
                        <option value="almoco">Almoço</option>
                        <option value="cafe-tarde">Café da tarde</option>
                        <option value="janta">Janta</option>
                        <option value="ceia">Ceia</option>
                    </select>
                    <button id="btn-registrar-refeicao">Registrar Alimentação</button>
                </div>
            </div>
        </div>

        <div id="calculadoraSentimentos" style="display: none;" class="calculadoraSentimentos">
            <div class="container_calc">
                <div class="header_calc">Como você se sentiu com essa atividade/alimentação?</div>
                <div class="buttons_calc">
                    <button class="button_calc negative" onclick="submitEmotion('Estressado')">Estressado</button>
                    <button class="button_calc negative" onclick="submitEmotion('Puto dms')">Puto dms</button>
                    <button class="button_calc negative" onclick="submitEmotion('Ansioso')">Ansioso</button>
                    <button class="button_calc neutral" onclick="submitEmotion('Fiz o L')">Fiz o L</button>
                    <button class="button_calc neutral" onclick="submitEmotion('Fiz o L 2 vezes')">Fiz o L 2
                        vezes</button>
                    <button class="button_calc positive" onclick="submitEmotion('Feliz')">Feliz</button>
                    <button class="button_calc positive" onclick="submitEmotion('Bem')">Bem</button>
                    <button class="button_calc positive" onclick="submitEmotion('Superação')">Superação</button>
                    <button class="button_calc positive"
                        onclick="submitEmotion('Determinação')">Determinação</button>
                </div>
            </div>

            <form id="emotionForm" action="registrar_emocao.php" method="POST" style="display: none;">
                <input type="hidden" name="emocao" id="emocaoInput">
            </form>
        </div>


    </div>

    <script src="../js/script.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch("../php/get_tipos_atividade.php")
                .then(response => response.text())
                .then(data => {
                    document.getElementById("tipo-atividade").innerHTML = data;
                })
                .catch(error => {
                    console.error("Erro ao carregar atividades:", error);
                    document.getElementById("tipo-atividade").innerHTML = "<option>Erro ao carregar</option>";
                });
        });
        document.addEventListener("DOMContentLoaded", function () {
            fetch("../php/get_registros_atividades.php")
                .then(response => response.text())
                .then(data => {
                    const tbody = document.querySelector(".tabela-atividades tbody");
                    tbody.innerHTML = data;
                })
                .catch(error => {
                    console.error("Erro ao carregar registros:", error);
                    const tbody = document.querySelector(".tabela-atividades tbody");
                    tbody.innerHTML = "<tr><td colspan='6'>Erro ao carregar registros</td></tr>";
                });
        });
        const formBuscarAlimento = document.getElementById('form-buscar-alimento');
        const inputAlimento = document.getElementById('alimento');
        const listaAlimentos = document.getElementById('lista-alimentos');
        const tabelaRefeicao = document.getElementById('tabela-refeicao').getElementsByTagName('tbody')[0]; // Agora é uma tabela
        const btnRegistrarRefeicao = document.getElementById('btn-registrar-refeicao');
        const alimentosSelecionados = []; // Agora armazenará objetos { nome: string, quantidade: number }

        formBuscarAlimento.addEventListener('submit', function(event) {
            event.preventDefault();
            const termoBusca = inputAlimento.value.trim();

            if (termoBusca) {
                buscarAlimentos(termoBusca);
            } else {
                listaAlimentos.innerHTML = '<li style="color: red;">Por favor, digite um nome de alimento.</li>';
            }
        });

        function buscarAlimentos(termo) {
            fetch(`../php/api_alimentos2.php?alimento=${termo}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Erro na busca de alimentos');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    listaAlimentos.innerHTML = ''; // Limpa a lista anterior
                    if (data.length > 0) {
                        data.forEach(alimento => {
                            const listItem = document.createElement('li');
                            listItem.className = 'item-alimento';
        
                            const nomeAlimentoSpan = document.createElement('span');
                            nomeAlimentoSpan.textContent = alimento.nome;
        
                            const selecionarIcone = document.createElement('i');
                            selecionarIcone.className = 'fas fa-angle-double-right icone-selecionar';
        
                            listItem.addEventListener('click', function () {
                                adicionarAlimentoSelecionado(alimento.id, alimento.nome);
                            });
        
                            listItem.appendChild(nomeAlimentoSpan);
                            listItem.appendChild(selecionarIcone);
                            listaAlimentos.appendChild(listItem);
                        });
                    } else {
                        listaAlimentos.innerHTML = '<li style="color: gray;">Nenhum alimento encontrado.</li>';
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar alimentos:", error);
                    listaAlimentos.innerHTML = `<li style="color: red;">${error.message}</li>`;
                });
        }
        


        function adicionarAlimentoSelecionado(id, nome) {
            const alimentoExistente = alimentosSelecionados.find(item => item.id === id);
            if (!alimentoExistente) {
                alimentosSelecionados.push({ id: id, nome: nome, quantidade: 1 });
                atualizarTabelaRefeicao();
            }
        }
        
        

        function removerAlimentoSelecionado(index) {
            alimentosSelecionados.splice(index, 1);
            atualizarTabelaRefeicao();
        }

        function atualizarQuantidade(index, quantidade) {
            alimentosSelecionados[index].quantidade = parseInt(quantidade);
        }

        function atualizarTabelaRefeicao() {
            tabelaRefeicao.innerHTML = '';
            alimentosSelecionados.forEach((item, index) => {
                const newRow = tabelaRefeicao.insertRow();

                const cellNome = newRow.insertCell();
                cellNome.textContent = item.nome;

                const cellQuantidade = newRow.insertCell();
                const quantidadeInput = document.createElement('input');
                quantidadeInput.type = 'number';
                quantidadeInput.className = 'quantidade-input';
                quantidadeInput.value = item.quantidade;
                quantidadeInput.min = 1;
                quantidadeInput.addEventListener('change', (event) => {
                    atualizarQuantidade(index, event.target.value);
                });
                cellQuantidade.appendChild(quantidadeInput);

                const cellAcoes = newRow.insertCell();
                const removerBotao = document.createElement('button');
                removerBotao.className = 'remover-item';
                removerBotao.innerHTML = '<i class="fas fa-trash-alt"></i>';
                removerBotao.addEventListener('click', () => removerAlimentoSelecionado(index));
                cellAcoes.appendChild(removerBotao);
            });
        }

        btnRegistrarRefeicao.addEventListener('click', function () {
            if (alimentosSelecionados.length === 0) {
                alert("Nenhum alimento selecionado.");
                return;
            }
        
            const refeicaoSelecionada = document.getElementById('refeicao').value;
            if (refeicaoSelecionada === "nao_selecionado") {
                alert("Selecione uma refeição antes de registrar.");
                return;
            }
        
            const jsonAlimentos = {
                refeicao: refeicaoSelecionada,
                alimentos: alimentosSelecionados.map(item => ({
                    id: item.id,
                    nome: item.nome,
                    quantidade: item.quantidade
                }))
            };
        
            console.log("JSON para envio:", JSON.stringify(jsonAlimentos));
        
            fetch('../php/buscar_nutrientes.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonAlimentos)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Resposta do servidor:', data);
                alert('Informações nutricionais recebidas com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao buscar nutrientes:', error);
                alert('Erro ao buscar informações nutricionais.');
            });
        });
        
        

            
        </script>

</body>
</html>